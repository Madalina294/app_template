<!-- Main Container -->
<div class="register-page-container">
  <!-- Registration Form Section -->
  <div class="register-card" *ngIf="!authResponse?.mfaEnabled">
    <nz-spin
      [nzSpinning]="isSpinning"
      [nzSize]="'large'"
      nzTip="Creating account..."
      class="register-spinner"
    >
      <div class="card-header">
        <h1 class="register-title">Create Account</h1>
        <p class="register-subtitle">Join us today and get started</p>
      </div>

      <form
        nz-form
        [formGroup]="registerForm"
        (ngSubmit)="registerUser()"
        class="register-form"
      >
        <!-- First Name -->
        <nz-form-item>
          <nz-form-control
            nzHasFeedback
            [nzErrorTip]="firstNameErrorTpl"
            [nzValidateStatus]="registerForm.controls['firstname']"
          >
            <input
              nz-input
              placeholder="First Name"
              formControlName="firstname"
              class="form-input"
            />
            <ng-template #firstNameErrorTpl let-control>
              <ng-container *ngIf="control.hasError('required')">
                First name is required
              </ng-container>
              <ng-container *ngIf="control.hasError('minlength')">
                First name must be at least 2 characters
              </ng-container>
            </ng-template>
          </nz-form-control>
        </nz-form-item>

        <!-- Last Name -->
        <nz-form-item>
          <nz-form-control
            nzHasFeedback
            [nzErrorTip]="lastNameErrorTpl"
            [nzValidateStatus]="registerForm.controls['lastname']"
          >
            <input
              nz-input
              placeholder="Last Name"
              formControlName="lastname"
              class="form-input"
            />
            <ng-template #lastNameErrorTpl let-control>
              <ng-container *ngIf="control.hasError('required')">
                Last name is required
              </ng-container>
              <ng-container *ngIf="control.hasError('minlength')">
                Last name must be at least 2 characters
              </ng-container>
            </ng-template>
          </nz-form-control>
        </nz-form-item>

        <!-- Profile Image (Optional) -->
        <nz-form-item>
          <nz-form-control>
            <label class="image-upload-label">Profile Picture (Optional)</label>
            <div class="image-upload-container">
              <div class="image-preview">
                <img
                  *ngIf="imagePreview"
                  [src]="imagePreview"
                  alt="Profile Preview"
                  class="preview-image"
                />
                <div *ngIf="!imagePreview" class="preview-placeholder">
                  <span class="preview-icon">ðŸ“·</span>
                  <span class="preview-text">No image selected</span>
                </div>
              </div>
              <div class="upload-actions">
                <input
                  type="file"
                  #fileInput
                  accept="image/*"
                  (change)="onFileSelected($event)"
                  class="file-input"
                  hidden
                />
                <button
                  type="button"
                  nz-button
                  nzType="default"
                  (click)="fileInput.click()"
                  class="upload-button"
                >
                  Choose Image
                </button>
                <button
                  *ngIf="imagePreview"
                  type="button"
                  nz-button
                  nzType="default"
                  nzDanger
                  (click)="removeImage()"
                  class="remove-button"
                >
                  Remove
                </button>
              </div>
            </div>
            <div class="upload-hint">
              Supported formats: JPG, PNG, GIF. Max size: 5MB
            </div>
          </nz-form-control>
        </nz-form-item>

        <!-- Email -->
        <nz-form-item>
          <nz-form-control
            nzHasFeedback
            nzErrorTip="Please enter a valid email address"
            [nzValidateStatus]="registerForm.controls['email']"
          >
            <input
              nz-input
              placeholder="Email address"
              formControlName="email"
              type="email"
              class="form-input"
            />
          </nz-form-control>
        </nz-form-item>

        <!-- Password -->
        <nz-form-item>
          <nz-form-control
            nzHasFeedback
            [nzErrorTip]="passwordErrorTpl"
            [nzValidateStatus]="registerForm.controls['password']"
          >
            <input
              nz-input
              placeholder="Password"
              type="password"
              formControlName="password"
              class="form-input"
            />
            <ng-template #passwordErrorTpl let-control>
              <ng-container *ngIf="control.hasError('required')">
                Password is required
              </ng-container>
              <ng-container *ngIf="control.hasError('pattern')">
                Password must contain at least 8 characters with uppercase,
                lowercase, number and special character
              </ng-container>
            </ng-template>
          </nz-form-control>
        </nz-form-item>

        <!-- Confirm Password -->
        <nz-form-item>
          <nz-form-control
            nzHasFeedback
            [nzErrorTip]="confirmPasswordErrorTpl"
            [nzValidateStatus]="registerForm.controls['confirmPassword']"
          >
            <input
              nz-input
              placeholder="Confirm Password"
              type="password"
              formControlName="confirmPassword"
              class="form-input"
            />
            <ng-template #confirmPasswordErrorTpl let-control>
              <ng-container *ngIf="control.hasError('required')">
                Please confirm your password
              </ng-container>
              <ng-container
                *ngIf="
                  registerForm.hasError('passwordsMismatch') && control.dirty
                "
              >
                Passwords do not match
              </ng-container>
            </ng-template>
          </nz-form-control>
        </nz-form-item>

        <!-- 2FA Checkbox -->
        <div class="checkbox-group">
          <label class="checkbox-container">
            <input
              type="checkbox"
              formControlName="mfaEnabled"
              class="checkbox-input"
            />
            <span class="checkmark"></span>
            <span class="checkbox-text"
              >Enable Two-Factor Authentication (Recommended)</span
            >
          </label>
          <p class="checkbox-description">
            Secure your account with an authenticator app. You'll be logged in
            automatically after setup.
          </p>
        </div>

        <button
          nz-button
          class="register-button"
          [nzType]="'primary'"
          type="submit"
          [disabled]="registerForm.invalid || isSpinning"
        >
          Create Account
        </button>

        <div class="login-link">
          Already have an account? <a routerLink="/login">Sign In</a>
        </div>
      </form>
    </nz-spin>
  </div>

  <!-- 2FA Setup Section -->
  <div class="register-card mfa-card" *ngIf="authResponse?.mfaEnabled">
    <nz-spin
      [nzSpinning]="isVerifying"
      [nzSize]="'large'"
      nzTip="Verifying code..."
      class="verify-spinner"
    >
      <div class="card-header">
        <h1 class="register-title">Setup Two-Factor Authentication</h1>
        <p class="register-subtitle">Secure your account with 2FA</p>
      </div>

      <div class="qr-section">
        <div class="qr-code-container">
          <img
            [src]="authResponse?.secretImageUri"
            alt="QR Code"
            class="qr-code"
          />
        </div>
        <p class="qr-instructions">
          Scan this QR code with Google Authenticator, Authy, or any compatible
          TOTP app
        </p>
      </div>

      <form class="verification-form">
        <nz-form-item>
          <label class="verification-label"
            >Enter the 6-digit code from your app</label
          >
          <input
            nz-input
            type="text"
            placeholder="000000"
            [(ngModel)]="otpCode"
            name="otpCode"
            maxlength="6"
            class="verification-input"
            [disabled]="isVerifying"
            (keyup.enter)="verifyTfa()"
          />
        </nz-form-item>

        <button
          nz-button
          [nzType]="'primary'"
          type="button"
          (click)="verifyTfa()"
          [disabled]="otpCode.length !== 6 || isVerifying"
          class="verify-button"
        >
          Complete Registration
        </button>

        <div class="help-section">
          <p class="help-text">
            <strong>Need help?</strong> Make sure your device's time is
            synchronized and that you've entered the code correctly.
          </p>
        </div>
      </form>
    </nz-spin>
  </div>
</div>
